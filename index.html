<!DOCTYPE html>
<html>
  <head>
    <title>DelayDiscounting</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <base href="/DelayDiscountingJS/">
    <script src="./jspsych/jspsych.js"></script>
    <script src="./jspsych/plugin-html-keyboard-response.js"></script>
    <script src="./jspsych/plugin-html-button-response.js"></script>
    <link href="./jspsych/jspsych.css" rel="stylesheet" type="text/css" />
    <script src="./main.js?v=2"></script>
    <style>
      #display_stage_background {
        width: 100vw;
        background-color: white;
        z-index: -1;
      }

      #display_stage {
        position: fixed;
        left: 1vw;
        top: 1vh;
        height: 98vh;
        width: 98vw;
        background-color: white;
        box-shadow: 1px 1px 1px #999;
        border-radius: 15px;
        z-index: 0;
        overflow-y: hidden;
        overflow-x: hidden; 
        }
        
      /* Target all possible button selectors */
      .button, .jspsych-btn, button, input[type="button"] {
        width: 320px !important; /* smaller box */
        height: 200px !important; /* smaller box */
        font-size: 22px !important; /* larger font */
        margin: 10px !important;
        padding: 22px !important; /* more breathing room for larger text */
        border: 2px solid #ccc !important;
        border-radius: 8px !important;
        background-color: #8c58db !important;
        background: #8c58db !important;
        cursor: pointer !important;
        text-align: center !important;
        display: inline-block !important;
        vertical-align: top !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        box-sizing: border-box !important;
        min-width: 320px !important;
        min-height: 200px !important;
        max-width: 320px !important;
        max-height: 200px !important;
        color: white !important;
      }
      
      /* Smaller Begin button for instructions */
      .begin-btn {
        width: 200px !important;
        height: 60px !important;
        min-width: 200px !important;
        min-height: 60px !important;
        max-width: 200px !important;
        max-height: 60px !important;
        font-size: 18px !important;
        padding: 10px !important;
      }
      
      .button:hover, .jspsych-btn:hover, button:hover, input[type="button"]:hover {
        background-color: #8c58db !important;
        background: #8c58db !important;
        border-color: #999 !important;
        color: white !important;
      }
      
      .button:active, .jspsych-btn:active, button:active, input[type="button"]:active {
        background-color: #7a49cb !important; /* slightly darker on press */
        background: #7a49cb !important;
        border-color: #666 !important;
        box-shadow: inset 0 2px 6px rgba(0,0,0,0.25) !important;
        transform: scale(0.98) !important;
        color: white !important;
      }

      /* Explicit pressed class to support mobile touch */
      .pressed {
        background-color: #7a49cb !important;
        background: #7a49cb !important;
        border-color: #666 !important;
        box-shadow: inset 0 2px 6px rgba(0,0,0,0.25) !important;
        transform: scale(0.98) !important;
        color: white !important;
      }
      
      .button:focus, .jspsych-btn:focus, button:focus, input[type="button"]:focus {
        background-color: #8c58db !important;
        background: #8c58db !important;
        color: white !important;
      }
      
      /* Mobile optimizations */
      @media screen and (max-width: 768px) {
        .button, .jspsych-btn, button, input[type="button"] {
          width: 48vw !important;
          height: 28vw !important; /* reduce box height */
          min-width: 220px !important;
          min-height: 150px !important;
          max-width: 320px !important;
          max-height: 200px !important;
          font-size: 22px !important; /* larger font */
          font-weight: 700 !important;
          line-height: 1.35 !important;
          margin: 6px !important;
          padding: 18px !important;
          border: 3px solid #ccc !important;
          touch-action: manipulation !important;
          -webkit-tap-highlight-color: transparent !important;
        }
        
        /* Stack buttons vertically on very small screens */
        @media screen and (max-width: 480px) {
          .button, .jspsych-btn, button, input[type="button"] {
            width: 88vw !important;
            height: 18vh !important; /* slightly shorter */
            min-width: 280px !important;
            min-height: 110px !important;
            max-width: 92vw !important;
            max-height: 22vh !important;
            font-size: 20px !important; /* larger font */
            font-weight: 700 !important;
            line-height: 1.25 !important;
            margin: 10px auto !important;
            padding: 16px !important;
            display: block !important;
          }
        }
        
        /* Extra small screens */
        @media screen and (max-width: 360px) {
          .button, .jspsych-btn, button, input[type="button"] {
            font-size: 16px !important;
            padding: 12px !important;
            line-height: 1.1 !important;
          }
        }
      }
      
      /* Touch device optimizations */
      @media (hover: none) and (pointer: coarse) {
        .button, .jspsych-btn, button, input[type="button"] {
          min-height: 44px !important;
          min-width: 44px !important;
          touch-action: manipulation !important;
          -webkit-tap-highlight-color: transparent !important;
        }
      }       
    </style>
  </head>
  <body></body>
  <script>

    // Track task start time for completion time calculation
    var taskStartTime = Date.now();

    /* initialize jsPsych */
    var jsPsych = initJsPsych({
        //timeline: timeline,
      on_finish: function() {
        // Check if running in iframe (Qualtrics integration)
        var isInIframe = window.self !== window.top;
        if (isInIframe) {
          // Collect trial data
          var allData = jsPsych.data.get().filter({trial_type: 'html-button-response'});
          var trialData = [];
          
          // Extract trial data (skip instructions)
          for (var i = 0; i < allData.count(); i++) {
            var trial = allData.values()[i];
            if (trial.index) { // Only include actual choice trials
              trialData.push({
                trialNum: trialData.length + 1,
                delayIndex: trial.index[0],
                delayLabel: trial.index[1],
                choseDelayed: trial.delay ? 1 : 0,
                response: trial.response,
                rt: trial.rt
              });
            }
          }
          
          // Send completion message to parent (Qualtrics)
          window.parent.postMessage({
            type: 'DELAY_DISCOUNTING_COMPLETE',
            data: trialData
          }, '*');
        } else {
          // Normal standalone mode - download data file with Qualtrics-compatible format
          var timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
          var filename = 'delay_discounting_data_' + timestamp + '.csv';
          
          // Process data to match Qualtrics embedded data structure
          var processedData = processDataForExport(jsPsych);
          saveQualtricsFormatCSV(processedData, filename);
          
          // Show completion screen with actual filename
          showCompletionScreen(filename);
        }
    }
    });
    
    /**
     * Processes jsPsych data to match Qualtrics embedded data structure
     * @param {Object} jsPsych - The jsPsych instance
     * @returns {Object} Processed data object with all Qualtrics-compatible fields
     */
    function processDataForExport(jsPsych) {
      var allData = jsPsych.data.get().filter({trial_type: 'html-button-response'});
      var trialData = [];
      var taskEndTime = Date.now();
      
      // Extract trial data (skip instructions)
      for (var i = 0; i < allData.count(); i++) {
        var trial = allData.values()[i];
        if (trial.index) { // Only include actual choice trials
          trialData.push({
            trialNum: trialData.length + 1,
            delayIndex: trial.index[0],
            delayLabel: trial.index[1],
            choseDelayed: trial.delay ? 1 : 0,
            response: trial.response,
            rt: trial.rt
          });
        }
      }
      
      // Calculate final delay index (indifference point)
      var finalDelayIndex = null;
      var finalDelayLabel = null;
      if (trialData.length > 0) {
        var lastTrial = trialData[trialData.length - 1];
        finalDelayIndex = lastTrial.delayIndex;
        finalDelayLabel = lastTrial.delayLabel;
      }
      
      // Calculate completion time using tracked start time
      var completionTime = (taskEndTime - taskStartTime) / 1000;
      
      // Build processed data object matching Qualtrics structure
      var processed = {
        // Individual trial data
        trials: trialData,
        // Summary fields
        finalDelayIndex: finalDelayIndex,
        finalDelayLabel: finalDelayLabel,
        completionTime: completionTime.toFixed(1),
        rawData: JSON.stringify(trialData),
        completed: 'Yes',
        startTime: new Date(taskStartTime).toISOString(),
        endTime: new Date(taskEndTime).toISOString()
      };
      
      return processed;
    }
    
    /**
     * Saves data in CSV format matching Qualtrics embedded data structure
     * @param {Object} data - Processed data object
     * @param {string} filename - Filename for the CSV file
     */
    function saveQualtricsFormatCSV(data, filename) {
      var csvRows = [];
      
      // Header row
      var headers = [];
      var values = [];
      
      // Add trial data fields
      for (var i = 1; i <= 5; i++) {
        headers.push('DD_Trial' + i + '_DelayIndex');
        headers.push('DD_Trial' + i + '_DelayLabel');
        headers.push('DD_Trial' + i + '_ChoseDelayed');
        
        if (i <= data.trials.length) {
          var trial = data.trials[i - 1];
          values.push(trial.delayIndex);
          values.push(trial.delayLabel);
          values.push(trial.choseDelayed);
        } else {
          values.push('');
          values.push('');
          values.push('');
        }
      }
      
      // Add summary fields
      headers.push('DD_FinalDelayIndex');
      headers.push('DD_FinalDelayLabel');
      headers.push('DD_CompletionTime');
      headers.push('DD_RawData');
      headers.push('DD_Completed');
      headers.push('DD_StartTime');
      headers.push('DD_EndTime');
      
      values.push(data.finalDelayIndex || '');
      values.push(data.finalDelayLabel || '');
      values.push(data.completionTime);
      values.push(data.rawData);
      values.push(data.completed);
      values.push(data.startTime);
      values.push(data.endTime);
      
      // Create CSV content
      csvRows.push(headers.join(','));
      
      // Escape values for CSV (handle commas, quotes, newlines)
      var escapedValues = values.map(function(val) {
        if (val === null || val === undefined) return '';
        var str = String(val);
        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
          return '"' + str.replace(/"/g, '""') + '"';
        }
        return str;
      });
      csvRows.push(escapedValues.join(','));
      
      // Convert to CSV string and download
      var csvContent = csvRows.join('\n');
      var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      var link = document.createElement('a');
      var url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    /**
     * Displays a completion screen after the task is finished
     * @param {string} filename - The name of the downloaded data file
     */
    function showCompletionScreen(filename) {
      var displayElement = jsPsych.getDisplayElement();
      displayElement.innerHTML = `
        <div style="text-align: center; padding: 40px 20px; font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
          <div style="font-size: clamp(36px, 8vw, 48px); margin-bottom: 20px;">âœ…</div>
          <h1 style="font-size: clamp(24px, 5vw, 32px); color: #8c58db; margin-bottom: 20px; font-weight: bold;">Task Completed!</h1>
          <p style="font-size: clamp(16px, 3vw, 18px); line-height: 1.6; margin-bottom: 30px; color: #333;">
            Thank you for completing the delay discounting task.<br><br>
            Your data has been automatically downloaded to your computer.
          </p>
          <div style="background-color: #f0f0f0; padding: 20px; border-radius: 8px; margin-bottom: 20px; word-break: break-all;">
            <p style="font-size: clamp(14px, 2.5vw, 16px); color: #666; margin: 0;">
              <strong>File name:</strong><br>
              <code style="font-size: clamp(12px, 2vw, 14px); color: #8c58db; background-color: white; padding: 5px 10px; border-radius: 4px; display: inline-block; margin-top: 8px;">${filename}</code>
            </p>
            <p style="font-size: clamp(12px, 2vw, 14px); color: #888; margin: 15px 0 0 0;">
              Check your Downloads folder if you don't see the file.
            </p>
          </div>
          <p style="font-size: clamp(14px, 2.5vw, 16px); color: #666;">
            You may now close this window.
          </p>
        </div>
      `;
    }
    /* add touch pressed-state handling for mobile */
    document.addEventListener('touchstart', function(e) {
      if (e.target && (e.target.matches('button') || e.target.closest('button'))) {
        var btn = e.target.closest('button');
        btn.classList.add('pressed');
      }
    }, { passive: true });

    document.addEventListener('touchend', function(e) {
      document.querySelectorAll('button.pressed').forEach(function(btn){
        btn.classList.remove('pressed');
      });
    }, { passive: true });

    document.addEventListener('touchcancel', function(e) {
      document.querySelectorAll('button.pressed').forEach(function(btn){
        btn.classList.remove('pressed');
      });
    }, { passive: true });

    /*start task*/
      jsPsych.run(timeline);
    

  </script>
</html>